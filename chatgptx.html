<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minimal Chat with Full Features</title>
<style>
  @font-face {
    font-family: 'fors';
    src: url('fors.ttf') format('truetype');
  }

  html, body {
    height: 100%;
    margin: 0; padding: 0;
    font-family: 'fors', sans-serif, Arial, sans-serif;
    background-color: #121212;
    color: white;
    display: flex;
    flex-direction: column;
  }

  #chat {
    flex-grow: 1;
    width: 95vw;
    margin: 10px auto 140px auto;
    padding: 20px;
    padding-left: 100px;
    overflow-y: auto;
    font-size: 15px;
  }

  .message {
    margin-bottom: 8px;
    line-height: 1.6;
    font-size: 15px;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-word;
  }

  .message.bot {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding-top: 12px;
    margin-top: 12px;
  }

  .user, .bot {
    background: none;
    color: white;
  }

  .editableNote {
    white-space: pre-wrap;
    background: none;
    color: white;
    padding: 4px;
    border: none;
    font-family: 'fors', sans-serif;
    font-size: 15px;
    outline: none;
  }

  #inputArea {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    width: 90vw;
    max-width: 600px;
    gap: 10px;
    background: #1e1e1e;
    padding: 12px 20px;
    border-radius: 12px;
    box-shadow:
      0 0 8px rgba(218, 181, 217, 0.6),
      0 0 16px rgba(218, 181, 217, 0.3);
    z-index: 100;
  }

  #noteInput {
    min-height: 60px;
    max-height: 400px;
    overflow-y: auto;
    font-size: 13px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #444;
    background: #222;
    color: white;
    outline: none;
    white-space: pre-wrap;
  }

  #noteInput:empty:before {
    content: attr(data-placeholder);
    color: #777;
    pointer-events: none;
    display: block;
  }

  #userInput {
    flex-grow: 1;
    font-size: 13px;
    padding: 10px 16px;
    border-radius: 12px;
    border: 1px solid #444;
    background: #222;
    color: white;
    outline: none;
  }

  #userInput:focus {
    border-color: #888;
    box-shadow: 0 0 6px rgba(169, 142, 170, 0.7);
  }

  #sendBtn {
    display: none;
  }

  #emojiColumn {
    position: fixed;
    top: 10px;
    left: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    z-index: 101;
  }

  .emoji, .format-btn {
    background: none;
    color: white;
    border: none;
    cursor: pointer;
    opacity: 0.7;
    font-size: 16px;
    transition: all 0.2s ease;
  }

  .emoji:hover, .format-btn:hover {
    transform: scale(1.2);
    opacity: 1;
  }

  #noteContainer {
    position: fixed;
    bottom: 40px;
    right: 20px;
    transform: 
    width: 50px;
    height: 50px;
    z-index: 103;
  }

  #addNoteToggle {
    width: 50px;
    height: 50px;
    font-size: 28px;
    border-radius: 50%;
    background: #dab5d9;
    color: black;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  #notePanel {
    position: absolute;
    bottom: 60px; /* appear just above the button */
    right: 0;
    width: 300px;
    background: #222;
    color: white;
    border-radius: 12px;
    padding: 16px;
    display: none;
    flex-direction: column;
    gap: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    z-index: 104;
  }

  #addNoteBtn {
    background: #333;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
  }

  .note-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: white;
    margin-right: 8px;
  }

  .message img {
    max-width: 100%;
    margin-top: 6px;
    border-radius: 8px;
  }

  .divider {
    height: 12px;
  }

  /* Auth section styling */
  #authSection {
    position: fixed;
    top: 12px;
    right: 12px;
    background: transparent;
    padding: 16px;
    border-radius: 12px;
    z-index: 104;
    width: 280px;
  }

  #authSection input {
    width: 100%;
    padding: 8px;
    margin-bottom: 8px;
    border-radius: 6px;
    border: none;
    outline: none;
    background: #333;
    color: white;
  }

  #authSection button {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background: #dab5d9;
    color: black;
    font-weight: bold;
    margin-bottom: 8px;
  }

  #userInfo {
    position: fixed;
    top: 12px;
    right: 16px;
    font-size: 12px;
    color: #ccc;
    background: transparent;
    padding: 2px 8px;
    font-weight: 500;
    z-index: 105;
  }

  #logoutBtn {
    position: fixed;
    top: 32px;
    right: 16px;
    background: none !important;
    color: #ccc !important;
    border: none !important;
    font-size: 16px !important;
    padding: 0 !important;
    margin: 0 !important;
    width: auto !important;
    height: auto !important;
    line-height: 1 !important;
    cursor: pointer;
    z-index: 105;
  }

  #logoutBtn:hover {
    transform: scale(1.2);
    color: white;
  }
  .highlighted {
  position: relative;
  font-weight: 500;
  color: inherit;
}

.highlighted::after {
  content: '';
  position: absolute;
  left: 0;
  bottom: 0;
  width: 100%;
  border-bottom: 1px dotted #aaa;
  animation: underlineFade 1.2s ease-in-out infinite alternate;
}

@keyframes underlineFade {
  from {
    opacity: 0.2;
  }
  to {
    opacity: 1;
  }
}


</style>
</head>
<body>

<div id="authSection">
  <input type="email" id="email" placeholder="Email" autocomplete="username" />
  <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
  <button id="loginBtn">Log In</button>
  <button id="logoutBtn" style="display:none;" title="Log Out">üö™</button>
  <div id="userInfo">Not logged in</div>
</div>

<div id="emojiColumn">
  <button class="format-btn" id="boldBtn">üÖ±Ô∏è</button>
  <button class="format-btn" id="highlightBtn">üí°</button>
  <button class="format-btn" id="resetColorBtn">üîÑ</button>
  <div class="divider"></div>
  <div class="emoji" data-emoji="üìå">üìå</div>
  <div class="emoji" data-emoji="üü°">üü°</div>
  <div class="emoji" data-emoji="üî¥">üî¥</div>
  <div class="emoji" data-emoji="üî∏">üî∏</div>
  <div class="emoji" data-emoji="‚ñ∂">‚ñ∂</div>
</div>

<!-- Container for add button and note panel -->
<div id="noteContainer">
  <button id="addNoteToggle" title="Add Note">Ôºã</button>
  <div id="notePanel">
    <div id="noteInput" contenteditable="true" data-placeholder="Type or paste your note here..."></div>
    <button id="addNoteBtn">Add Note</button>
  </div>
</div>

<div id="chat"></div>

<form id="inputArea">
  <input type="text" id="userInput" placeholder="Type here..." autocomplete="off" required />
  <button type="submit" id="sendBtn">Send</button>
</form>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDtv3x9PAMzZUW6yVuUSLgLzA0ejcDidF4",
    authDomain: "notes-chat-c5ff3.firebaseapp.com",
    projectId: "notes-chat-c5ff3",
    storageBucket: "notes-chat-c5ff3.appspot.com",
    messagingSenderId: "597780727252",
    appId: "1:597780727252:web:8407eb4096dbe301d74241",
    measurementId: "G-YQD63H7L5T"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const chat = document.getElementById('chat');
  const userInput = document.getElementById('userInput');
  const inputArea = document.getElementById('inputArea');
  const noteInput = document.getElementById('noteInput');
  const addNoteBtn = document.getElementById('addNoteBtn');
  const addNoteToggle = document.getElementById('addNoteToggle');
  const notePanel = document.getElementById('notePanel');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const userInfo = document.getElementById('userInfo');

  // Show/hide note panel & addNoteToggle only when logged in
  function updateUIForUser(user) {
    if (user) {
      userInfo.textContent = 'Logged in as ' + user.email;
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'block';
      emailInput.style.display = 'none';
      passwordInput.style.display = 'none';
      addNoteToggle.style.display = 'inline-block';
      notePanel.style.display = 'none'; // Hidden until toggle clicked
    } else {
      userInfo.textContent = 'Not logged in';
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      emailInput.style.display = 'inline-block';
      passwordInput.style.display = 'inline-block';
      addNoteToggle.style.display = 'none';
      notePanel.style.display = 'none';
    }
  }

  auth.onAuthStateChanged(user => {
    updateUIForUser(user);
  });

  loginBtn.onclick = async () => {
    try {
      await auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value);
    } catch (err) {
      alert('Login failed: ' + err.message);
    }
  };

  logoutBtn.onclick = () => auth.signOut();

  addNoteToggle.onclick = () => {
    if (notePanel.style.display === 'flex') {
      notePanel.style.display = 'none';
    } else {
      notePanel.style.display = 'flex';
      noteInput.focus();
    }
  };

  function addMessage(sender, text) {
    const div = document.createElement('div');
    div.className = 'message ' + sender;
    div.textContent = (sender === 'user' ? 'üßë ' : 'ü§ñ ') + text;
    chat.appendChild(div);
    chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
  }

  addNoteBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user) {
      alert('Please log in to add notes.');
      return;
    }
    const noteText = noteInput.innerHTML.trim();
    if (!noteText) return alert("Please enter a note.");

    addNoteBtn.disabled = true;
    addNoteBtn.textContent = "Adding...";

    try {
      await db.collection('notes').add({
        content: noteText,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        uid: user.uid
      });
      addMessage('bot', '‚úÖ Note added!');
      noteInput.innerHTML = '';
      notePanel.style.display = 'none';
    } catch (e) {
      alert('Error: ' + e.message);
    } finally {
      addNoteBtn.disabled = false;
      addNoteBtn.textContent = "Add Note";
    }
  };

  async function queryNotes(question) {
    const snapshot = await db.collection('notes').orderBy('createdAt', 'desc').get();
    return snapshot.docs
      .filter(doc => doc.data().content.toLowerCase().includes(question.toLowerCase()))
      .map(doc => ({ ...doc.data(), id: doc.id }));
  }

  function displayNotes(notes, query = '') {
    chat.innerHTML = '';

    if (notes.length === 0) {
      addMessage('bot', '‚ùå No matching notes found.');
      return;
    }

    const highlightText = (html, keyword) => {
  if (!keyword) return html;

  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = html;

  const walk = node => {
    if (node.nodeType === 3) {
      const text = node.nodeValue;
      const escaped = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${escaped})`, 'gi');
      const parts = text.split(regex);

      if (parts.length > 1) {
        const frag = document.createDocumentFragment();
        parts.forEach(part => {
          if (part.toLowerCase() === keyword.toLowerCase()) {
            const span = document.createElement('span');
            span.className = 'highlighted';
            span.textContent = part;
            frag.appendChild(span);
          } else {
            frag.appendChild(document.createTextNode(part));
          }
        });
        node.replaceWith(frag);
      }
    } else if (node.nodeType === 1 && node.childNodes) {
      [...node.childNodes].forEach(walk);
    }
  };

  [...tempDiv.childNodes].forEach(walk);
  return tempDiv.innerHTML;
};



    notes.forEach(({ content, id }, index) => {
      const div = document.createElement('div');
      div.className = 'message bot';
      if (index > 0) div.style.borderTop = '1px solid rgba(255, 255, 255, 0.1)';

      const noteText = document.createElement('div');
      noteText.className = 'editableNote';
      noteText.contentEditable = false;
      noteText.innerHTML = highlightText(content, query);
      div.appendChild(noteText);

      const btns = document.createElement('div');
      const editBtn = document.createElement('button');
      editBtn.className = 'note-btn';
      editBtn.textContent = '‚úèÔ∏è';
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'note-btn';
      deleteBtn.textContent = 'üóëÔ∏è';
      btns.append(editBtn, deleteBtn);
      div.appendChild(btns);

      let editing = false;
      editBtn.onclick = () => {
        if (!editing) {
          editing = true;
          noteText.contentEditable = true;
          noteText.focus();
          editBtn.textContent = '‚úÖ';
        } else {
          const updated = noteText.innerHTML.trim();
          if (!updated) return alert("Cannot be empty");
          db.collection('notes').doc(id).update({ content: updated });
          noteText.contentEditable = false;
          editBtn.textContent = '‚úèÔ∏è';
          editing = false;
        }
      };

      deleteBtn.onclick = () => {
        if (confirm("Delete this note?")) {
          db.collection('notes').doc(id).delete();
          chat.removeChild(div);
        }
      };

      chat.appendChild(div);
    });
  }

  inputArea.onsubmit = async (e) => {
    e.preventDefault();
    const question = userInput.value.trim();
    if (!question) return;
    addMessage('user', question);
    userInput.value = '';
    addMessage('bot', '‚è≥ Searching...');
    const results = await queryNotes(question);
    const lastBot = [...chat.querySelectorAll('.bot')].pop();
    if (lastBot && lastBot.textContent.includes('Searching')) chat.removeChild(lastBot);
    displayNotes(results, question);
  };

  // Emojis and formatting
  document.querySelectorAll('.emoji').forEach(btn => {
    btn.onclick = () => {
      navigator.clipboard.writeText(btn.dataset.emoji);
      btn.style.transform = 'scale(1.3)';
      setTimeout(() => (btn.style.transform = 'scale(1)'), 200);
    };
  });

  document.getElementById('boldBtn').onclick = () => {
    document.execCommand('bold');
  };

  document.getElementById('highlightBtn').onclick = () => {
    document.execCommand('foreColor', false, '#FAFABE'); // Yellow font color
  };

  document.getElementById('resetColorBtn').onclick = () => {
    document.execCommand('foreColor', false, 'white');
  };

  addMessage('bot', 'üëã Welcome X! Please log in to add or manage notes.');
</script>

</body>
</html>
