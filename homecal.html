<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendar and To-Do Page</title>
  
<style>
@font-face {
  font-family: 'hellohon';
  src: url('hellohon.otf') format('opentype');
}


body {
  margin: 0;
  font-family: Tahoma, sans-serif;
  font-size: 10pt;
  height: 100vh;
  display: flex;
  flex-wrap: nowrap;
  overflow-x: hidden; /* prevent blank horizontal scroll area */
  background: url('2b1.png') center center / cover no-repeat fixed;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

.calendar,
.calendar * {
  font-family: Tahoma, sans-serif;
  font-weight: 300;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

/* Shared glass container styling (BOTH) */
.calendar-container,
.todo-container {
  position: relative;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(12px) saturate(120%);
  -webkit-backdrop-filter: blur(12px) saturate(120%);
  border: 1px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
  transition: box-shadow 0.3s ease;
  overflow: hidden;
  min-width: 0; /* flex overflow safety */
}

/* Calendar (left) */
.calendar-container {
  flex: 1 1 auto;
  padding: 8px;
  max-height: 100vh;
  border-radius: 12px 0 0 12px;
  overflow-y: auto;
}

/* Background blur layers */
.calendar-container::before,
.todo-container::before {
  content: "";
  position: absolute;
  inset: 0;
  background: url('2b1√ü.png') no-repeat;
  background-size: cover;
  filter: blur(10px);
  transform: scale(1.05);
  z-index: -1;
  pointer-events: none;
}

.calendar-container::before { background-position: left top; }

/* Todo (right) ‚Äî IMPORTANT: do NOT combine this with calendar styles */
.todo-container {
  flex: 0 0 350px;
  max-width: 350px;
  min-width: 150px;
  padding: 3px;
  border-radius: 0 12px 12px 0;
  white-space: normal;
  max-height: 100vh;

  display: flex;          /* ADD */
  flex-direction: column; /* ADD */
}

.todo-container::before { background-position: right top; }

.calendar-container:hover,
.todo-container:hover {
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18),
              0 0 10px rgba(255, 255, 255, 0.35);
}

.todo-title {
  font-size: 60px;
  text-align: center;
  margin-bottom: 10px;
  font-family: 'hellohon', cursive;
  font-weight: 400;
  color: black;
}

/* Scroll area ONLY (no big glass box) */
.todo-list {
  width: 100%;
  box-sizing: border-box;

  flex: 1;
  min-height: 0;
  overflow-y: auto;
  overflow-x: hidden;

  /* remove the big container look */
  background: transparent;
  border: none;
  backdrop-filter: none;
  -webkit-backdrop-filter: none;

  /* spacing for items */
  padding: 6px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.todo-item {
  display: flex;
  align-items: stretch;
  gap: 8px;               /* slightly tighter */
  padding: 6px 8px;       /* less padding = more usable space */

  width: 100%;
  box-sizing: border-box;

  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.30);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);

  border-radius: 12px;
}

.todo-item:hover {
  box-shadow:
    inset 0 0 6px rgba(255,255,255,0.2),
    0 2px 6px rgba(0,0,0,0.05);
}


/* Action container hidden by default */
.todo-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex: 0 0 auto;

  opacity: 0;
  transition: opacity 0.2s ease;
}

/* Show only when hovering the todo item */
.todo-item:hover .todo-actions {
  opacity: 1;
}

/* Minimal glass buttons */
.todo-actions button {
  width: 24px;
  height: 24px;
  padding: 0;

  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.08);

  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);

  color: rgba(0,0,0,0.55);
  font-size: 13px;
  line-height: 1;
  cursor: pointer;

  transition: background .2s ease, border-color .2s ease, transform .15s ease;
}

.todo-actions button:hover {
  background: rgba(255,255,255,0.18);
  border-color: rgba(255,255,255,0.35);
  transform: translateY(-1px);
}

.todo-actions button:hover{
  background: rgba(255,255,255,0.18);
  border-color: rgba(255,255,255,0.35);
  transform: translateY(-1px);
}

.todo-actions button:active{
  transform: translateY(0);
}

.todo-item textarea {
  font-family: Tahoma, sans-serif;
  color: #000;
  opacity: 1;
}

/* keep readOnly looking normal */
.todo-item textarea[readonly] {
  cursor: default;
}

/* optional: show subtle focus when editing */
.todo-item textarea:not([readonly]):focus {
  outline: none;
  box-shadow: 0 0 6px rgba(255,255,255,0.6);
}

.todo-item input[type="text"],
.todo-item textarea {
  flex: 1 1 0;
  min-width: 0;

  padding: 2px 4px;   /* tighter */
  margin: 0;

  border: none;
  background: transparent;

  font-family: Tahoma, sans-serif;
  font-size: 10pt;
  line-height: 1.4;

  resize: none;
  overflow-y: hidden;

  box-sizing: border-box;
}

.todo-item { width: 100%; box-sizing: border-box; }

.todo-item > div:last-child {
  flex: 0 0 auto;
}

.todo-item input[type="checkbox"] {
  margin-right: 10px;
  width: 20px;
  height: 20px;
  accent-color: #ffe700;
}


.add-todo {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.add-todo input {
  flex: 1;
  padding: 8px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px 0 0 8px;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  color: black;
}

.add-todo button {
  padding: 8px;
  border: none;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  cursor: pointer;
  border-radius: 0 8px 8px 0;
  color: #333;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.add-todo button:hover {
  background: rgba(255, 255, 255, 0.4);
  box-shadow: 0 0 8px rgba(170, 200, 255, 0.4);
}

button,
.add-todo button,
.home-button,
.emoji-button,
.calendar-header > div > button {
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  color: black;
  cursor: pointer;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
  padding: 6px 12px;
  font-size: 10pt;
}

button:hover,
.add-todo button:hover,
.home-button:hover,
.emoji-button:hover,
.calendar-header > div > button:hover {
  background: rgba(255, 255, 255, 0.4);
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}

.calendar-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.calendar-header h2#monthLabel {
  font-size: 50pt;
  margin: 0;
  color: black;
  font-family: 'hellohon', cursive, sans-serif;
}

#monthLabel {
  font-family: 'hellohon', cursive, sans-serif;
  font-weight: 400;
  color: rgba(255, 255, 255, 0.85);
}

.calendar-header select {
  padding: 6px 12px;
  font-size: 10pt;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(193, 182, 163, 0.3);
  border-radius: 8px;
  color: black;
  cursor: pointer;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
  -webkit-appearance: none;
  appearance: none;
}

.calendar-header select:hover {
  background: rgba(255, 255, 255, 0.4);
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
}

.home-button {
  padding: 4px 8px;
  background-color: #ddd3d2;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 8pt;
  color: white;
}

.day-headers {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  margin-top: 10px;
  font-weight: bold;
  text-align: center;
  color: black;
}

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 10px;
  margin-top: 5px;
}

.day {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 6px;
  min-height: 150px;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  box-shadow:
    inset 0 0 8px rgba(255, 255, 255, 0.2),
    0 3px 6px rgba(0, 0, 0, 0.08);
  position: relative;
  overflow: hidden;
  will-change: transform, box-shadow;
}

.day:hover {
  box-shadow:
    inset 0 0 8px rgba(255, 255, 255, 0.2),
    0 3px 6px rgba(0, 0, 0, 0.08);
  transform: none;
  transition: none;
}

.day.empty {
  background: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  box-shadow: none !important;
  border: none !important;
  padding: 0 !important;
  min-height: 0 !important;
  pointer-events: none;
}

.day textarea {
  width: 100%;
  min-height: 110px;
  max-height: 600px;
  height: auto;
  resize: none;
  overflow-y: hidden;
  border-radius: 8px;
  padding: 4px;
  font-family: 'champ', sans-serif;
  font-size: 9.5pt;
  box-sizing: border-box;
  transition: height 0.2s ease;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.day .date-number {
  font-weight: bold;
  color: black;
  margin-bottom: 5px;
  font-size: 10pt;
}

.day.today {
  transform: scale(1.13);
  z-index: 5;
  box-shadow:
    0 0 20px rgba(255, 255, 255, 0.9),
    0 0 30px rgba(190, 230, 255, 0.6);
  border: 2px solid rgba(255, 255, 255, 0.9);
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0.6),
    rgba(210, 240, 255, 0.4)
  );
}

.day textarea:focus {
  outline: none;
  box-shadow: 0 0 6px rgba(180, 220, 255, 0.8);
  background: rgba(255, 255, 255, 0.4);
}

@media (max-width: 600px) {
  body { flex-wrap: wrap; }

  .calendar-container,
  .todo-container {
    width: 100% !important;
    max-width: 100% !important;
    border-radius: 12px !important;
  }

  .calendar { gap: 4px; }

  .day {
    min-height: 120px;
    padding: 6px;
    font-size: 9pt;
  }

  .day textarea {
    background-color: white;
    font-size: 9pt;
    min-height: 40px;
  }

  .calendar-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .calendar-header h2#monthLabel { font-size: 20pt; }

  .day-headers {
    font-size: 9pt;
    gap: 4px;
  }
}

/* Match highlight */
.day.match {
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(8px) saturate(120%);
  -webkit-backdrop-filter: blur(8px) saturate(120%);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  border-radius: 12px;
}

/* =========================
   ULTRA SUBTLE GLASS SCROLLBAR
   ========================= */

/* Firefox */
.todo-list,
.calendar-container {
  scrollbar-width: thin;
  scrollbar-color: transparent transparent;
}

/* WebKit */
.todo-list::-webkit-scrollbar,
.calendar-container::-webkit-scrollbar {
  width: 6px;   /* thinner = more elegant */
  height: 6px;
}

/* Invisible track */
.todo-list::-webkit-scrollbar-track,
.calendar-container::-webkit-scrollbar-track {
  background: transparent;
}

/* Fully hidden by default */
.todo-list::-webkit-scrollbar-thumb,
.calendar-container::-webkit-scrollbar-thumb {
  background: transparent;
  border-radius: 20px;
  transition: background 0.25s ease, box-shadow 0.25s ease;
}

/* Almost transparent frosted glass on hover */
.todo-list:hover::-webkit-scrollbar-thumb,
.calendar-container:hover::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.18);
  border: 1px solid rgba(255,255,255,0.25);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

/* Slightly stronger while dragging */
.todo-list::-webkit-scrollbar-thumb:active,
.calendar-container::-webkit-scrollbar-thumb:active {
  background: rgba(255,255,255,0.28);
}

/* Firefox hover */
.todo-list:hover,
.calendar-container:hover {
  scrollbar-color: rgba(255,255,255,0.25) transparent;
}

</style>

</head>

<body>
  <div class="calendar-container">
  <div class="calendar-header">
    <div class="calendar-header-left">
    
		
		<input 
    type="text" 
    id="noteFilterInput" 
    placeholder="search" 
    oninput="filterNotes()" 
    class="glass-input"
/>

<style>
.glass-input {
    background: transparent;       /* fully see-through */
    border: none;                  /* no border at all */
    padding: 4px 0;
    font-size: 11px;
    width: 120px;
    color: black;                  /* typed text is normal */
    outline: none;
}

.glass-input::placeholder {
    color: rgba(0, 0, 0, 0.05);   /* extremely faint placeholder */
    font-style: italic;            /* optional subtle style */
}

.glass-input:focus::placeholder {
    color: rgba(0, 0, 0, 0.03);   /* even fainter on focus */
}


.calendar-header-left {
    display: flex;
    align-items: center;   /* vertically align search box */
    gap: 10px;             /* spacing between search + emoji buttons */
}

#newTodoInput {
  width: 100%;
  min-height: 32px;
  resize: none;
  overflow-y: hidden;
  font-family: Tahoma, sans-serif;
  line-height: 1.4;
}
.add-todo textarea {
  flex: 1;
  min-height: 36px;
  resize: none;
  overflow-y: hidden;
  line-height: 1.4;
  font-family: Tahoma, sans-serif;

  background: rgba(255, 255, 255, 0.25);
  border: 1px solid rgba(255,255,255,0.4);
  border-radius: 10px;
  padding: 10px;
  color: black;

  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.add-todo textarea::placeholder {
  color: rgba(255,255,255,0.7);
}
.emoji-popup {
  position: fixed;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px) saturate(140%);
  -webkit-backdrop-filter: blur(10px) saturate(140%);
  border: 1px solid rgba(255, 255, 255, 0.35);
  padding: 8px;
  border-radius: 10px;
  display: flex;
  gap: 8px;
  z-index: 9999;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
}

.emoji-popup.hidden {
  display: none;
}

.emoji-popup button {
  background: rgba(255,255,255,0.3);
  border: none;
  border-radius: 10px;
  font-size: 10px;
  padding: 4px 8px;
  cursor: pointer;
}

.emoji-popup button:hover {
  background: rgba(255,255,255,0.5);
}


</style>

    </div>
	
    <h2 id="monthLabel">Monthly Calendar</h2>
    <div>
		 <button onclick="window.location.href='https://xlyneve.github.io/CEP/home.html'">Home</button>
      <button onclick="changeMonth(-1)">‚óÄ</button>
      <button onclick="goToToday()">Today</button>
      <select id="monthSelect"></select>
      <select id="yearSelect"></select>
      <button onclick="changeMonth(1)">‚ñ∂</button>
    </div>
  </div>
<div class="note-filter-bar" style="
  width: 50%;
  max-width: 100px;
  margin: 10px auto;
  display: flex;
  justify-content: center;
">

</div>
  <div class="day-headers">
    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
  </div>

  <div class="calendar" id="calendar"></div>
</div> <!-- End of .calendar-container -->



 <div class="todo-container">
  <div class="todo-title">To-Do List</div>

  <div class="todo-list" id="todoList"></div>

  <div class="add-todo">
    <textarea id="newTodo" placeholder="Add new task..."></textarea>
    <button onclick="addTodo()">Add</button>
  </div>
</div>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, onSnapshot, deleteDoc, addDoc
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSy***************",
  authDomain: "cepx-f9d2a.firebaseapp.com",
  projectId: "cepx-f9d2a",
  storageBucket: "cepx-f9d2a.appspot.com",
  messagingSenderId: "840696526325",
  appId: "1:840696526325:web:b9bcb4669fbfad066a1cbc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentDate = new Date();
const calendarEl = document.getElementById('calendar');
const monthLabel = document.getElementById('monthLabel');
const monthSelect = document.getElementById('monthSelect');
const yearSelect = document.getElementById('yearSelect');
const todoInput = document.getElementById('newTodo');
const todoListEl = document.getElementById('todoList');

const months = [...Array(12).keys()].map(i =>
  new Date(0, i).toLocaleString('default', { month: 'long' })
);

// Populate month/year selectors
function populateSelectors() {
  months.forEach((m, i) => {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = m;
    monthSelect.appendChild(option);
  });

  const thisYear = new Date().getFullYear();
  for (let y = thisYear - 5; y <= thisYear + 5; y++) {
    const option = document.createElement('option');
    option.value = y;
    option.textContent = y;
    yearSelect.appendChild(option);
  }

  monthSelect.addEventListener('change', () => {
    currentDate.setMonth(parseInt(monthSelect.value));
    loadCalendar();
  });
  yearSelect.addEventListener('change', () => {
    currentDate.setFullYear(parseInt(yearSelect.value));
    loadCalendar();
  });
}

// Go to today
function goToToday() {
  currentDate = new Date();
  loadCalendar();
}

// Change month
function changeMonth(offset) {
  currentDate.setMonth(currentDate.getMonth() + offset);
  loadCalendar();
}

// Days in month
function getDaysInMonth(month, year) {
  return new Date(year, month + 1, 0).getDate();
}

// Day name
function getDayName(year, month, day) {
  return new Date(year, month, day).toLocaleDateString('en-US', { weekday: 'short' });
}

// Load calendar for a month
async function loadCalendar() {
  const month = currentDate.getMonth();
  const year = currentDate.getFullYear();
  calendarEl.innerHTML = '';
  monthLabel.textContent = `${months[month]} ${year}`;
  monthSelect.value = month;
  yearSelect.value = year;

  const daysInMonth = getDaysInMonth(month, year);
  const firstDay = new Date(year, month, 1).getDay() || 7;

  const docRef = doc(db, 'calendar', `${year}-${month + 1}`);
  let notes = {};
  const snap = await getDoc(docRef);
  if (snap.exists()) notes = snap.data();

  // Blank days before first day
  for (let i = 1; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'day empty';
    calendarEl.appendChild(empty);
  }

  // Days with notes
  for (let i = 1; i <= daysInMonth; i++) {
    const note = notes[i] || "";
    const day = document.createElement('div');
    day.className = 'day';

    const today = new Date();
    if (i === today.getDate() &&
        month === today.getMonth() &&
        year === today.getFullYear()) {
      day.classList.add('today');
    }

    day.innerHTML = `<div class="date-number">${getDayName(year, month, i)} ${i}</div><textarea>${note}</textarea>`;
    const textarea = day.querySelector('textarea');
    textarea.addEventListener('input', e => {
      autoResizeTextarea(e.target);
      saveCalendar(year, month + 1, i, e.target.value);
    });

    calendarEl.appendChild(day);
    autoResizeTextarea(textarea);
  }
  autoResizeAllDayTextareas();
}

// Save note
async function saveCalendar(year, month, day, note) {
  const ref = doc(db, 'calendar', `${year}-${month}`);
  try {
    await updateDoc(ref, { [day]: note });
  } catch {
    await setDoc(ref, { [day]: note }, { merge: true });
  }
}

// Auto resize textareas
function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = textarea.scrollHeight + 'px';
}
function autoResizeAllDayTextareas() {
  document.querySelectorAll('.day textarea').forEach(autoResizeTextarea);
}

const newTodo = document.getElementById('newTodo');

newTodo.addEventListener('input', () => autoResizeTextarea(newTodo));

// ensure fresh reset on load
autoResizeTextarea(newTodo);


// To-do functions
async function addTodo() {
  const value = todoInput.value.trim();
  if (value) {
    await addDoc(collection(db, 'todos'), { text: value, done: false });
    todoInput.value = '';
  }
}
function renderTodoItem(id, text, done) {
  const item = document.createElement('div');
  item.className = 'todo-item';

  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.checked = done;
  checkbox.onchange = () =>
    updateDoc(doc(db, 'todos', id), { done: checkbox.checked });

  const input = document.createElement('textarea');
  input.value = text;
  input.readOnly = true;
  input.style.flex = '1';
  input.style.border = 'none';
  input.style.background = 'transparent';
  input.style.resize = 'none';
  input.style.overflow = 'hidden';

  // initial autoresize on render
  autoResizeTextarea(input);

  // autoresize while typing
  input.addEventListener('input', () => autoResizeTextarea(input));

  const buttonContainer = document.createElement('div');
buttonContainer.className = 'todo-actions';

const editBtn = document.createElement('button');
editBtn.type = 'button';
editBtn.title = 'Edit';
editBtn.textContent = '‚úé';   // minimalist pencil

editBtn.onclick = async () => {
  if (input.readOnly) {
    // enter edit mode
    input.readOnly = false;
    input.focus();

    setTimeout(() => autoResizeTextarea(input), 20);
    editBtn.textContent = 'üíæ';
  } else {
    // save changes
    await updateDoc(doc(db, 'todos', id), { text: input.value });
    input.readOnly = true;

    autoResizeTextarea(input);
    editBtn.textContent = '‚úèÔ∏è';
  }
};

const deleteBtn = document.createElement('button');
deleteBtn.type = 'button';
deleteBtn.title = 'Delete';
deleteBtn.textContent = '√ó';  // minimalist delete

deleteBtn.onclick = async () => {
  if (confirm("Delete this to-do?"))
    await deleteDoc(doc(db, 'todos', id));
};

buttonContainer.append(editBtn, deleteBtn);

  item.append(checkbox, input, buttonContainer);
  todoListEl.appendChild(item);

  // safe double-pass autoresize for long text loaded from db
  setTimeout(() => autoResizeTextarea(input), 30);
}

// Load todos
function loadTodos() {
  const ref = collection(db, 'todos');
  onSnapshot(ref, snap => {
    todoListEl.innerHTML = '';
    snap.forEach(doc => renderTodoItem(doc.id, doc.data().text, doc.data().done));
  });
}

// --- FILTER FUNCTION: SHOW ALL MATCHING NOTES GROUPED BY MONTH ---
async function filterNotes() {
  const term = document.getElementById("noteFilterInput").value.trim(); // Get the filter input and remove leading/trailing spaces
  
  // If the search term is empty, reload the full calendar (no filtering)
  if (!term) {
    loadCalendar();
    return;
  }

  // Create a regular expression for partial word matching (case-insensitive)
  const regExp = new RegExp(term, 'i'); // 'i' flag for case-insensitivity
  
  // Get all calendar documents (month-year as document ID)
  const calendarRef = collection(db, 'calendar');
  const allDocs = await getDocs(calendarRef);

  // Clear the existing calendar content
  calendarEl.innerHTML = '';

  // Iterate over all documents in the calendar collection
  allDocs.forEach(docSnap => {
    const [year, month] = docSnap.id.split('-').map(Number); // Split the document ID into year and month
    const notes = docSnap.data(); // Get the notes data for that month
    
    // Filter the days based on whether the notes contain the search term (using regex for partial matching)
    const matchingDays = Object.keys(notes).filter(day => {
      return regExp.test(notes[day]); // Test if the note contains the search term (case-insensitive)
    });

    // If there are matching days, display them grouped by month
    if (matchingDays.length > 0) {
      // Create the month-year header (e.g., "June 2025")
      const header = document.createElement('div');
      header.className = 'month-header';
      header.textContent = `${months[month - 1]} ${year}`;  // Adjust for zero-indexing if necessary
      calendarEl.appendChild(header);

      // Create a day element for each day with matching notes
      matchingDays.forEach(dayNum => {
        const day = document.createElement('div');
        day.className = 'day match'; // Add 'match' class for styling of matched days

        // Create the day content with the note for that day
        day.innerHTML = `
          <div class="date-number">${getDayName(year, month - 1, dayNum)} ${dayNum}</div>
          <textarea readonly>${notes[dayNum]}</textarea> <!-- Display the note for the matched day -->
        `;

        // Append the day to the calendar
        calendarEl.appendChild(day);
        autoResizeAllDayTextareas(); // Auto-resize all day textareas to fit content
      });
    }
  });
}


// Expose functions
window.changeMonth = changeMonth;
window.goToToday = goToToday;
window.addTodo = addTodo;
window.filterNotes = filterNotes;

// Initial load
populateSelectors();
loadCalendar();
loadTodos();
window.addEventListener('resize', () => {
  document.querySelectorAll('.todo-item textarea, .day textarea').forEach(autoResizeTextarea);
  autoResizeAllDayTextareas();
});

let activeTextarea = null;
const emojiPopup = document.getElementById("emojiPopup");

// SHOW EMOJI POPUP ON DAY CLICK
document.addEventListener("click", (e) => {
    const dayBox = e.target.closest(".day");

    if (dayBox) {
        const rect = dayBox.getBoundingClientRect();

        // find textarea inside day
        activeTextarea = dayBox.querySelector("textarea");

        // position popup (centered above the day)
        emojiPopup.style.left = rect.left + rect.width / 2 + "px";
        emojiPopup.style.top = rect.top - 55 + "px";

        emojiPopup.classList.remove("hidden");
        return;
    }

    // CLICK OUTSIDE ‚Üí CLOSE POPUP
    if (!e.target.closest("#emojiPopup")) {
        emojiPopup.classList.add("hidden");
    }
});

// INSERT EMOJI INTO CURRENT DAY NOTE
window.insertEmoji = function(emoji) {
    if (!activeTextarea) return;

    const cursorPos = activeTextarea.selectionStart;
    const text = activeTextarea.value;

    activeTextarea.value =
        text.slice(0, cursorPos) + emoji + " " + text.slice(cursorPos);

    activeTextarea.focus();
    activeTextarea.selectionEnd = cursorPos + emoji.length + 1;

    autoResizeTextarea(activeTextarea);

    // keep popup open (optional)
};

</script>


<!-- EMOJI POPUP -->
<div id="emojiPopup" class="emoji-popup hidden">
  <button onclick="insertEmoji('‚òê')">‚òê</button>
  <button onclick="insertEmoji('‚úÖ')">‚úÖ</button>
  <button onclick="insertEmoji('üü°')">üü°</button>
	<button onclick="insertEmoji('‚ñ™Ô∏è')">‚ñ™Ô∏è</button>
  <button onclick="insertEmoji('üìå')">üìå</button>
	<button onclick="insertEmoji('‚ö†Ô∏è')">‚ö†Ô∏è</button>
	<button onclick="insertEmoji('üìä')">üìä</button>
  <button onclick="insertEmoji('üå∏')">üå∏</button>
	<button onclick="insertEmoji('‚úàÔ∏è')">‚úàÔ∏è</button>
</div>

</body>
</html>

