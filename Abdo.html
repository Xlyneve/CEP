<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAgYsVQNEOyQa41NkXXT2VuKClqXAxfG1Q",
    authDomain: "cepx-f9d2a.firebaseapp.com",
    projectId: "cepx-f9d2a",
    storageBucket: "cepx-f9d2a.appspot.com",
    messagingSenderId: "840696526325",
    appId: "1:840696526325:web:b9bcb4669fbfad066a1cbc"
  };

  // Initialize Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  } else {
    firebase.app(); // If already initialized, use that one
  }
  const db = firebase.firestore();
  const storage = firebase.storage();

  async function saveNote() {
    const title = document.getElementById("title").value.trim();
    const rawNotes = document.getElementById("notes").value.trim();
    const file = document.getElementById("imageUpload").files[0];

    // Check if all inputs are empty
    if (!title && !rawNotes && !file) {
      alert("Please enter a title, note, or upload an image.");
      return;
    }

    // Show saving status
    const statusElement = document.getElementById("imageStatus");
    statusElement.textContent = "Saving note...";
    const saveButton = document.querySelector(".save");
    saveButton.disabled = true;

    let imageUrl = "";

    try {
      // If a file is provided, upload it to Firebase Storage
      if (file) {
        const storageRef = storage.ref().child(`abdominis/${Date.now()}_${file.name}`);
        const snapshot = await storageRef.put(file);
        imageUrl = await snapshot.ref.getDownloadURL();
        console.log("Image uploaded successfully:", imageUrl);
      }

      // Save note to Firestore
      await db.collection("abdominisNotes").add({
        title: title || "Untitled", // Default title if empty
        rawNotes: rawNotes || "No content", // Default content if empty
        image: imageUrl,
        created: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Reset form inputs
      document.getElementById("title").value = "";
      document.getElementById("notes").value = "";
      document.getElementById("imageUpload").value = "";
      statusElement.textContent = "Note saved successfully!";
      saveButton.disabled = false;

      // Refresh notes display
      displayNotes();
    } catch (error) {
      console.error("Error saving note:", error);
      statusElement.textContent = `Error: ${error.message}`;
      saveButton.disabled = false;
    }
  }

  async function displayNotes() {
    const container = document.getElementById("notesContainer");
    container.innerHTML = ""; // Clear previous notes

    try {
      const snapshot = await db.collection("abdominisNotes").orderBy("created", "desc").get();
      snapshot.forEach(doc => {
        const note = doc.data();
        const tile = document.createElement("div");
        tile.className = "tile";

        const titleEl = document.createElement("h4");
        titleEl.innerText = note.title;

        const noteEl = document.createElement("p");
        noteEl.innerHTML = note.rawNotes
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/==(.+?)==/g, '<mark>$1</mark>');

        tile.appendChild(titleEl);
        tile.appendChild(noteEl);

        if (note.image) {
          const imgEl = document.createElement("img");
          imgEl.src = note.image;
          imgEl.onclick = () => showModal(note.image);
          tile.appendChild(imgEl);
        }

        container.appendChild(tile);
      });
    } catch (error) {
      console.error("Error displaying notes:", error);
    }
  }

  function showModal(src) {
    const modalImage = document.getElementById("modalImage");
    const imageModal = document.getElementById("imageModal");
    modalImage.src = src;
    imageModal.classList.add("show");
  }

  function closeModal() {
    const imageModal = document.getElementById("imageModal");
    imageModal.classList.remove("show");
  }

  function searchNote() {
    const keyword = document.getElementById("searchInput").value.toLowerCase();
    const allTiles = document.querySelectorAll(".tile");

    allTiles.forEach(tile => {
      const title = tile.querySelector("h4").innerText.toLowerCase();
      const noteText = tile.querySelector("p").innerText.toLowerCase();
      tile.style.display = title.includes(keyword) || noteText.includes(keyword) ? "block" : "none";
    });
  }

  window.onload = displayNotes;
</script>