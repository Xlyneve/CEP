<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INFORMATIONS</title>
  <style>
@font-face {
  font-family: 'fors';
  src: url('fors.ttf') format('truetype'); /* Adjust the path */
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: 'Tahoma', sans-serif;
  overflow-x: hidden;
  position: relative;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

/* Background image with full-page blur overlay */
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: url('2b.png') no-repeat center center fixed;
  background-size: cover;
  filter: blur(10px) brightness(0.9);
  z-index: -1;
}

.header-title {
  position: absolute;
  top: 30px;
  left: 80px;
  transform: none;
  font-size: 22px;
  font-weight: bold;
  color: #000;
  text-align: left;
  z-index: 60;
  pointer-events: auto;
  opacity: 0; /* Start hidden */
  animation: fadeIn 1.5s ease forwards; /* Trigger fade-in */
}

/* Add keyframes for fade-in */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

a.header-link {
  position: relative;
  z-index: 1000;
  pointer-events: auto;
}

.header a:hover {
  background-color: #b88eaa;
}

.home-btn {
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  box-shadow: 0 4px 10px rgba(255, 255, 255, 0.25);
  color: black;
  text-decoration: none;
  font-weight: bold;
  padding: 8px 12px;
  border-radius: 50px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
  z-index: 1000;
}

.home-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  box-shadow: 0 6px 14px rgba(255, 255, 255, 0.45);
}

.search-bar {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 6px;
}

.search-input {
  width: 150px;
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  font-size: 13px;
  background: rgba(255, 255, 255, 0.15);
  color: black;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  box-shadow: 0 4px 10px rgba(255, 255, 255, 0.25);
  transition: background-color 0.3s ease;
}

.search-input:focus {
  background: rgba(255, 255, 255, 0.3);
  outline: none;
}

.container {
  width: 100%;
  padding: 100px 20px 20px; /* top padding increased for header space */
  box-sizing: border-box;
  max-width: 100vw;
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 20px;
}

input[type="text"],
textarea {
  display: block;
  margin: 0.2rem auto;
  padding: 0.5rem;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  font-size: 13px;
  width: 90%;
  max-width: 500px;
  background: rgba(255, 255, 255, 0.25);
  font-family: Tahoma, sans-serif;
  color: #222;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 4px 10px rgba(255, 255, 255, 0.25);
  transition: background-color 0.3s ease;
  z-index: 1;
}

input[type="text"]:focus,
textarea:focus {
  background: rgba(255, 255, 255, 0.35);
  outline: none;
}

.format-buttons,
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 6px 0 10px 0;
  flex-wrap: wrap;
  align-items: center;
}

.format-buttons button,
.add-btn,
.btn-group button,
.editor-buttons button {
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  color: black;
  box-shadow: 0 4px 10px rgba(255, 255, 255, 0.25);
  border-radius: 6px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 400;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.format-buttons button:hover,
.add-btn:hover,
.btn-group button:hover,
.editor-buttons button:hover {
  background: rgba(255, 255, 255, 0.3);
  box-shadow: 0 6px 14px rgba(255, 255, 255, 0.45);
  color: black;
}

.add-btn {
  font-weight: 600;
  z-index: 10;
}

/* ---------------- Masonry / Pinterest Style ---------------- */
.cards-container {
  column-count: 4;        /* Desktop columns */
  column-gap: 16px;       /* Space between columns */
  width: 100%;
  padding: 10px 0;
  box-sizing: border-box;
}

.note-card {
  display: inline-block;  /* Required for masonry */
  width: 90%;            /* Fill column width */
  margin-bottom: 16px;
  break-inside: avoid;    /* Prevent splitting across columns */

  padding: 15px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.25);
  border: 1px solid rgba(255, 255, 255, 0.4);
  box-shadow: 0 8px 32px rgba(100, 100, 150, 0.15),
              0 0 10px rgba(255, 255, 255, 0.2);
  transition: transform 0.2s ease-in-out;
}

.note-card:hover {
  transform: scale(1.04);
  box-shadow: 
    inset 0 3px 8px rgba(220, 240, 255, 0.6),
    0 0 15px 6px rgba(220, 240, 255, 0.45),
    0 10px 30px rgba(190, 210, 240, 0.15);
}

/* Responsive columns */
@media (max-width: 1200px) {
  .cards-container { column-count: 3; }
}
@media (max-width: 768px) {
  .cards-container { column-count: 2; }
}
@media (max-width: 480px) {
  .cards-container { column-count: 1; }
}

/* Note contents */
.note-title {
  font-weight: bold;
  font-size: 14px;
  color: black;
  margin-bottom: 6px;
}

.note-text {
  color: black;
  font-size: 11px;
  white-space: pre-wrap;
  font-family: Tahoma, sans-serif;
}

.note-text strong {
  font-weight: bold;
}

.note-text mark {
  background-color: #feb7ab;
}

.note-url a {
  font-size: 12px;
  color: brown;
  word-break: break-word;
  margin-top: 8px;
  display: inline-block;
  text-decoration: none;
}

.timestamp {
  font-size: 11px;
  color: #777;
  margin-top: 10px;
}

.edit-title {
  width: 100%;
  margin-bottom: 6px;
  padding: 6px 10px;
  font-family: Tahoma, sans-serif;
  font-size: 11px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.2);
  color: #222;
  transition: background-color 0.3s ease;
}

.edit-note {
  width: 90%;
  min-height: 60px;
  padding: 6px 8px;
  font-family: Tahoma, sans-serif;
  font-size: 11px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.4);
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.2);
  color: #222;
  resize: vertical;
  transition: background-color 0.3s ease;
}

.edit-title:focus,
.edit-note:focus {
  background: rgba(255, 255, 255, 0.4);
  outline: none;
}

.btn-group {
  margin-top: 10px;
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
.edit-note:empty:before {
  content: attr(data-placeholder);
  color: #888;
  pointer-events: none;
  display: block;
}

.styled-link {
  display: inline-block;
  margin-top: 8px;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 6px;
  font-size: 11px;
  font-weight: bold;
  color: black !important;
  text-decoration: none;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  transition: background-color 0.3s ease;
}

.styled-link:hover {
  background: rgba(255, 255, 255, 0.3);
}
.input-group {
  display: none; /* hide initially */
}
#toggleInputBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  font-size: 28px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(6px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 1000;
  transition: background 0.3s, transform 0.2s;
}

#toggleInputBtn:hover {
  background: rgba(255,255,255,0.35);
  transform: scale(1.1);
}

/* üå∏ Toggle + Rays (updated) */
.center-toggle {
  position: fixed;
  top: 20px;
  left: 800px;
  width: 30px;
  height: 30px;
  z-index: 1002;
}
/* üå∏ Glassmorphism style for rays */
.center-toggle .ray {
  background: rgba(255, 255, 255, 1);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 6px 12px;
  color: #000;
  text-decoration: none !important;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
  font-weight: 500;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transform: rotate(var(--angle)) translate(0px);
  transition: 
    opacity 0.4s ease, 
    transform 0.4s ease; /* smooth transition */
}

/* Show rays when active */
.center-toggle.active .ray {
  opacity: 1;
  pointer-events: auto;
}

/* Ray hover effect ‚Äî change box color */
.center-toggle .ray:hover {
  background: #ededed;
  transform: scale(1.05);
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}

.toggle-icon {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: #2d4d2d;
  cursor: pointer;
  transition: transform 0.4s ease;
}

.toggle-icon.active {
  transform: rotate(45deg);
}

.rays {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  pointer-events: auto;
  transform: translate(-50%, -50%);
  z-index: 1003;
}

.ray {
  position: absolute;
  top: 0;
  left: 0;
  font-size: 14px;
  font-weight: 400;
  color: #2f4f2f;
  opacity: 0;
  transform-origin: 0 0;
  white-space: nowrap;
  transform: rotate(var(--angle)) translate(40px);
  transition: opacity 0.5s ease;
  pointer-events: none;
}

.ray span {
  display: inline-block;
  transform: rotate(calc(-1 * var(--angle)));
  transition: color 0.3s ease;
}

/* Text color hover effect */
.ray:hover span {
  color: #F0EEEA;
}

/* Mobile adjustments */
@media (max-width: 768px) {
  .center-toggle {
    top: 15px;
    left: 10px;
    width: 50px;
    height: 50px;
  }
}



/* Mobile & Tablet Adjustments */
@media (max-width: 768px) {
  .header {
    height: 60px;
    padding: 0 10px;
  }
  .header-title {
    font-size: 20px;
  }
  .search-box input {
    width: 120px;
    font-size: 11px;
  }
  .container {
    padding: 80px 10px 10px;
  }
}

@media only screen and (max-width: 480px) {
  .main-header {
    position: relative;
    padding: 8px 0;
    text-align: center;
    font-size: 18px;
    box-shadow: none;
  }

  .main-header h1 {
    font-size: 20px;
    margin: 10px 0;
    display: block;
  }

  .home-btn,
  .search-container {
    position: relative !important;
    display: inline-block;
    top: auto;
    left: auto;
    right: auto;
    margin: 5px 10px;
  }

  body {
    padding-top: 0 !important;
  }

  .header-title {
    font-size: 18px;
    left: 50%;
    transform: translateX(-50%);
  }
}


  </style>
</head>
<body>


<div class="header">
 <div class="header-bg"></div>

  <div class="header-left">
    <!-- üå∏ Home toggle with rays -->
<div class="center-toggle">
  <div class="toggle-icon" id="menuToggle">‚òê</div>
  <div class="rays">
    <!-- Rays will be generated dynamically by JS -->
  </div>
</div>
</div>


  <div class="header-title">INFORMATIONS</div>
  <div class="search-bar" id="searchBox">
    <input type="text" id="searchInput" class="search-input" placeholder="Search..." />
  </div>
</div>

<div class="container">

  <!-- Input group (hidden by default, slides up) -->
  <div class="input-group" id="inputGroup" style="
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:20px;
      position: fixed;
      bottom: -400px;   /* start off-screen */
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 530px;
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(10px);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      transition: bottom 0.4s ease;
      z-index: 999;
    ">
    <input type="text" id="noteTitle" placeholder="Title" />

    <!-- Live editable note area -->
    <div id="noteText" 
         class="edit-note" 
         contenteditable="true" 
         data-placeholder="Write your explanation..."
         style="
           min-height:80px; 
           max-height:180px; 
           width:100%; 
           overflow-y:auto;
           padding:6px 8px;
           box-sizing:border-box;
         ">
    </div>

    <input type="text" id="noteUrl" placeholder="Optional URL" />
	<input type="file" id="noteImage" accept="image/*" style="
  margin: 6px 0;
  padding: 4px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.4);
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(8px);
  font-size: 12px;
  color: #222;
">

	
	

    <div class="action-buttons">
      <div class="format-buttons">
        <button type="button" onclick="document.execCommand('bold')"><strong>Bold</strong></button>
        <button type="button" onclick="document.execCommand('hiliteColor', false, '#feb7ab')"><mark>Highlight</mark></button>
      </div>
      <button class="add-btn" id="addBtn">Add Note</button>
    </div>
  </div>

  <!-- Masonry note container -->
  <div class="cards-container" id="notesContainer">
    <!-- Notes are dynamically populated via JS -->
  </div>
</div>

<!-- Floating toggle button -->
<button id="toggleInputBtn" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  font-size: 28px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(6px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 1000;
">+</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAgYsVQNEOyQa41NkXXT2VuKClqXAxfG1Q",
  authDomain: "cepx-f9d2a.firebaseapp.com",
  projectId: "cepx-f9d2a",
  storageBucket: "cepx-f9d2a.appspot.com",
  messagingSenderId: "840696526325",
  appId: "1:840696526325:web:b9bcb4669fbfad066a1cbc"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------- State ---------------- */
let notes = [];
const notesContainer = document.getElementById('notesContainer');
const LONG_PRESS_MS = 600;

/* ---------------- Utilities ---------------- */
function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
function maybeParseLegacy(text) {
  if (text.indexOf('<') === -1) {
    let s = escapeHtml(text);
    s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/==(.+?)==/g, '<mark>$1</mark>');
    s = s.replace(/\n/g, '<br>');
    return s;
  }
  return text;
}
function closestTagWithin(node, tagName, container) {
  tagName = tagName.toUpperCase();
  let el = (node && node.nodeType === 3) ? node.parentNode : node;
  while (el && el !== container) {
    if (el.nodeType === 1 && el.tagName === tagName) return el;
    el = el.parentNode;
  }
  return null;
}
function unwrapElement(el) {
  if (!el || !el.parentNode) return;
  const parent = el.parentNode;
  while (el.firstChild) parent.insertBefore(el.firstChild, el);
  parent.removeChild(el);
}
function toggleHighlightInEditor(editor) {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  if (!editor.contains(range.commonAncestorContainer)) return;
  const m1 = closestTagWithin(sel.anchorNode, 'MARK', editor);
  const m2 = closestTagWithin(sel.focusNode, 'MARK', editor);
  let toggledOff = false;
  if (m1) { unwrapElement(m1); toggledOff = true; }
  if (m2 && m2.isConnected) { unwrapElement(m2); toggledOff = true; }
  if (toggledOff) return;
  if (range.collapsed) return;
  const mark = document.createElement('mark');
  mark.style.backgroundColor = '#feb7ab';
  try {
    range.surroundContents(mark);
    sel.removeAllRanges();
    const r = document.createRange();
    r.selectNodeContents(mark);
    sel.addRange(r);
  } catch (_) {
    const frag = range.cloneContents();
    const temp = document.createElement('div');
    temp.appendChild(frag);
    const html = temp.innerHTML;
    document.execCommand('insertHTML', false, `<mark style="background-color:#feb7ab;">${html}</mark>`);
  }
}
async function copyPlainText(text, onDone) {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
    } else {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
    if (onDone) onDone();
  } catch (e) { console.error('Copy failed', e); }
}

/* ---------------- Create note (with optional image) ---------------- */
document.getElementById('addBtn').addEventListener('click', async () => {
  const title = document.getElementById('noteTitle').value.trim();
  const textEl = document.getElementById('noteText');
  const text = (textEl ? textEl.innerHTML : '').trim();
  const url = document.getElementById('noteUrl').value.trim();
  const fileInput = document.getElementById('noteImage');
  const file = fileInput ? fileInput.files[0] : null;
  if (!title || !text) return alert("Please fill in both Title and Explanation.");

  let imageBase64 = "";
  if (file) {
    const reader = new FileReader();
    reader.onloadend = async () => {
      imageBase64 = reader.result;
      await addDoc(collection(db, "informationNotes"), { title, text, url, image: imageBase64, timestamp: Date.now() });
      resetAddForm();
    };
    reader.readAsDataURL(file);
  } else {
    await addDoc(collection(db, "informationNotes"), { title, text, url, image: "", timestamp: Date.now() });
    resetAddForm();
  }
});

function resetAddForm() {
  document.getElementById('noteTitle').value = '';
  if (document.getElementById('noteText')) document.getElementById('noteText').innerHTML = '';
  document.getElementById('noteUrl').value = '';
  const fileInput = document.getElementById('noteImage');
  if (fileInput) fileInput.value = '';
}

/* ---------------- Real-time updates ---------------- */
onSnapshot(collection(db, "informationNotes"), (snapshot) => {
  notes = [];
  snapshot.forEach(docSnap => notes.push({ id: docSnap.id, ...docSnap.data() }));
  const searchVal = document.getElementById('searchInput').value.trim().toLowerCase();
  if (searchVal) {
    const filtered = notes.filter(n =>
      (n.title || '').toLowerCase().includes(searchVal) ||
      (String(n.text || '')).toLowerCase().includes(searchVal)
    );
    renderNotes(filtered);
  } else {
    renderNotes(notes);
  }
});

/* ---------------- Render ---------------- */
function renderNotes(arr) {
  notesContainer.innerHTML = '';
  if (!arr.length) { notesContainer.innerHTML = '<p>No notes found.</p>'; return; }
  arr.forEach(note => {
    const card = document.createElement('div');
    card.className = 'note-card';
    card.dataset.id = note.id;
    card.style.position = 'relative';

    // Tick feedback
    const tick = document.createElement('div');
    tick.textContent = '‚úì';
    Object.assign(tick.style, {
      position: 'absolute', top: '8px', right: '8px',
      width: '28px', height: '28px', borderRadius: '50%',
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      fontSize: '24px', fontWeight: '990', color: '#ffe700',
      opacity: '0', transform: 'scale(0.85)', transition: 'opacity 200ms ease, transform 200ms ease'
    });
    card.appendChild(tick);

    // Title
    const titleEl = document.createElement('div');
    titleEl.className = 'note-title';
    titleEl.textContent = note.title;
    const titleInput = document.createElement('input');
    titleInput.type = 'text';
    titleInput.className = 'edit-title';
    titleInput.value = note.title;
    titleInput.style.display = 'none';

    // Optional URL
    const urlEl = document.createElement('div');
    urlEl.className = 'note-url';
    if (note.url) {
      const link = document.createElement('a');
      link.href = note.url; link.target = '_blank'; link.rel = 'noopener noreferrer';
      link.textContent = 'URL Link'; link.className = 'styled-link';
      urlEl.appendChild(link);
    }

    // Text display
    const textDisplay = document.createElement('div');
    textDisplay.className = 'note-text';
    textDisplay.innerHTML = maybeParseLegacy(note.text || '');

    // Text editor
    const textEditor = document.createElement('div');
    textEditor.className = 'edit-note'; textEditor.contentEditable = true;
    textEditor.style.display = 'none'; textEditor.innerHTML = maybeParseLegacy(note.text || '');
    textEditor.style.minHeight = '60px'; textEditor.style.maxHeight = '200px'; textEditor.style.overflowY = 'auto'; textEditor.style.margin = '8px 0';

    // Optional image
    let imgEl = null;
    if (note.image) {
      imgEl = document.createElement('img');
      imgEl.src = note.image;
      imgEl.style.maxWidth = '100%';
      imgEl.style.marginTop = '10px';
      imgEl.style.borderRadius = '6px';
      imgEl.style.cursor = 'zoom-in';
      card.appendChild(imgEl);

      // Zoom modal
      const modal = document.getElementById("imgModal");
      const modalImg = document.getElementById("modalImg");
      imgEl.addEventListener("click", () => {
        if (modal && modalImg) { modal.style.display = "flex"; modalImg.src = imgEl.src; }
      });
     const closeModalBtn = document.getElementById('closeModalBtn');

closeModalBtn.addEventListener('click', () => {
  modal.style.display = 'none';
  ctx.clearRect(0,0,canvas.width,canvas.height);
});

    }

    // Timestamp
    const timeEl = document.createElement('div');
    timeEl.className = 'timestamp';
    timeEl.textContent = `Added: ${new Date(note.timestamp).toLocaleString()}`;

    // Buttons
    const btnGroup = document.createElement('div');
    btnGroup.className = 'btn-group'; btnGroup.style.display = 'none';
    const editBtn = document.createElement('button'); editBtn.textContent = 'Edit'; editBtn.title='Edit'; editBtn.addEventListener('click', e=>{ e.stopPropagation(); toggleEdit(card,true); });
    const saveBtn = document.createElement('button'); saveBtn.textContent = 'Save'; saveBtn.title='Save'; saveBtn.style.display='none'; saveBtn.addEventListener('click', e=>{ e.stopPropagation(); saveEdit(card); });
    const cancelBtn = document.createElement('button'); cancelBtn.textContent = 'Cancel'; cancelBtn.title='Cancel'; cancelBtn.style.display='none'; cancelBtn.addEventListener('click', e=>{ e.stopPropagation(); toggleEdit(card,false); });
    const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Delete'; deleteBtn.title='Delete'; deleteBtn.addEventListener('click', e=>{ e.stopPropagation(); deleteNote(note.id); });
    btnGroup.append(editBtn, saveBtn, cancelBtn, deleteBtn);

    // Editor formatting
    const editorBtns = document.createElement('div'); editorBtns.className='editor-buttons'; editorBtns.style.display='none';
    const boldBtn = document.createElement('button'); boldBtn.textContent='Bold'; boldBtn.title='Bold'; boldBtn.addEventListener('click', e=>{ e.stopPropagation(); document.execCommand('bold'); });
    const highlightBtn = document.createElement('button'); highlightBtn.textContent='Highlight'; highlightBtn.title='Highlight'; highlightBtn.addEventListener('click', e=>{ e.stopPropagation(); toggleHighlightInEditor(textEditor); });
    editorBtns.append(boldBtn, highlightBtn);

    // Assemble card
    card.append(titleEl, titleInput, urlEl, textDisplay, textEditor, editorBtns, timeEl, btnGroup);
    notesContainer.appendChild(card);

    // Long press
    let pressTimer = null, longPressed=false;
    const startPress = ()=>{ if(textEditor.style.display==='block') return; longPressed=false; pressTimer=setTimeout(()=>{ btnGroup.style.display='flex'; longPressed=true; }, LONG_PRESS_MS); };
    const endPress = ()=>{ if(pressTimer) clearTimeout(pressTimer); setTimeout(()=>{longPressed=false;},10); };
    card.addEventListener('mousedown', startPress);
    card.addEventListener('mouseup', endPress);
    card.addEventListener('mouseleave', endPress);
    card.addEventListener('touchstart', startPress,{passive:true});
    card.addEventListener('touchend', endPress);

    // Click to copy
    card.addEventListener('click', e=>{
      if(textEditor.style.display==='block') return;
      if(longPressed) return;
      if(e.target.closest('.btn-group')) return;
      if(e.target.closest('.editor-buttons')) return;
      if(e.target.closest('.note-url')) return;
      copyPlainText(textDisplay.innerText, ()=>{
        tick.style.opacity='1'; tick.style.transform='scale(1)';
        setTimeout(()=>{ tick.style.opacity='0'; tick.style.transform='scale(0.85)'; },900);
      });
    });
  });
}

/* ---------------- Edit / Save / Delete ---------------- */
function toggleEdit(card, editing){
  const titleEl = card.querySelector('.note-title');
  const titleInput = card.querySelector('.edit-title');
  const textDisplay = card.querySelector('.note-text');
  const textEditor = card.querySelector('.edit-note');
  const btnGroup = card.querySelector('.btn-group');
  const editorBtns = card.querySelector('.editor-buttons');
  const [editBtn, saveBtn, cancelBtn] = btnGroup.querySelectorAll('button');
  if(editing){
    titleEl.style.display='none'; titleInput.style.display='block';
    textDisplay.style.display='none'; textEditor.style.display='block';
    btnGroup.style.display='flex'; editBtn.style.display='none';
    saveBtn.style.display='inline-block'; cancelBtn.style.display='inline-block';
    editorBtns.style.display='flex'; textEditor.focus();
  } else {
    titleEl.style.display='block'; titleInput.style.display='none';
    textDisplay.style.display='block'; textEditor.style.display='none';
    editBtn.style.display=''; saveBtn.style.display='none'; cancelBtn.style.display='none';
    editorBtns.style.display='none';
  }
}

async function saveEdit(card){
  const id=card.dataset.id;
  const textEditor=card.querySelector('.edit-note');
  const titleInput=card.querySelector('.edit-title');
  const newText=textEditor.innerHTML.trim();
  const newTitle=titleInput.value.trim();
  if(!newTitle||!newText) return alert("Title and explanation cannot be empty.");
  await updateDoc(doc(db,"informationNotes",id),{title:newTitle,text:newText});
  toggleEdit(card,false);
  // Reapply search
  const searchVal = document.getElementById('searchInput').value.trim().toLowerCase();
  const filtered = searchVal ? notes.filter(n=>(n.title||'').toLowerCase().includes(searchVal)||(String(n.text||'')).toLowerCase().includes(searchVal)) : notes;
  renderNotes(filtered);
}

async function deleteNote(id){
  if(!confirm("Are you sure you want to delete this note?")) return;
  await deleteDoc(doc(db,"informationNotes",id));
}

/* ---------------- Search ---------------- */
document.getElementById('searchInput').addEventListener('input',(e)=>{
  const val=e.target.value.toLowerCase();
  const filtered=notes.filter(n=>(n.title||'').toLowerCase().includes(val)||(String(n.text||'')).toLowerCase().includes(val));
  renderNotes(filtered);
});

/* ---------------- Toggle Input Group ---------------- */
const toggleBtn=document.getElementById('toggleInputBtn');
const inputGroup=document.getElementById('inputGroup');
let isOpen=false;
toggleBtn.addEventListener('click',()=>{
  if(!isOpen){ inputGroup.style.bottom='80px'; toggleBtn.textContent='‚àí'; inputGroup.scrollIntoView({behavior:'smooth'}); }
  else{ inputGroup.style.bottom='-400px'; toggleBtn.textContent='+'; }
  isOpen=!isOpen;
});

/* ---------------- Rays Menu ---------------- */
const centerToggle=document.querySelector('.center-toggle');
const toggleIcon=document.getElementById("menuToggle");
const raysContainer=centerToggle.querySelector(".rays");
let hoverTimeout;
let currentSet=0;
const raySets=[
  [ { text: "Home", link: "https://xlyneve.github.io/CEP/home.html" },
    { text: "Nurse Notes", link: "https://xlyneve.github.io/CEP/PN.html" },
    { text: "Template", link: "https://xlyneve.github.io/CEP/explain.html" },
    { text: "PN", link: "https://xlyneve.github.io/CEP/practiceN.html" },
    { text: "Recall", link: "https://xlyneve.github.io/CEP/recalls.html" } ],
  [ { text: "Drug Calculator", link: "https://xlyneve.github.io/CEP/OHcalc.html" },
    { text: "Vaccine Calc", link: "https://xlyneve.github.io/CEP/vaccine-spacing.html" },
    { text: "Vaccines", link: "https://xlyneve.github.io/CEP/complete-vaccine-info.html" },
    { text: "Meds list", link: "https://xlyneve.github.io/CEP/Npres.html" } ]
];
const angles=["-20deg","20deg","60deg","100deg","140deg","180deg"];
function showRays(){ raysContainer.querySelectorAll('.ray').forEach(ray=>{ ray.style.opacity=1; ray.style.pointerEvents='auto'; }); }
function hideRays(){ raysContainer.querySelectorAll('.ray').forEach(ray=>{ ray.style.opacity=0; ray.style.pointerEvents='none'; }); }
centerToggle.addEventListener('mouseenter',()=>{ if(!toggleIcon.classList.contains("active")){ clearTimeout(hoverTimeout); showRays(); } });
centerToggle.addEventListener('mouseleave',()=>{ if(!toggleIcon.classList.contains("active")){ hoverTimeout=setTimeout(()=>{ hideRays(); },1000); } });
toggleIcon.addEventListener("click",()=>{
  toggleIcon.classList.add("active");
  raysContainer.innerHTML="";
  const set=raySets[currentSet];
  set.forEach((rayData,i)=>{
    const ray=document.createElement("a");
    ray.className="ray"; ray.href=rayData.link; ray.textContent=rayData.text; ray.style.opacity="0";
    ray.style.setProperty("--angle", angles[i]||"0deg"); ray.style.pointerEvents="auto";
    raysContainer.appendChild(ray);
    setTimeout(()=>{ ray.style.opacity="1"; ray.style.transform=`rotate(${angles[i]||"0deg"}) translate(60px)`; ray.style.pointerEvents="auto"; },50);
  });
  currentSet=(currentSet+1)%raySets.length;
});
function hideAllRays(){ raysContainer.querySelectorAll(".ray").forEach(ray=>{ ray.style.opacity="0"; ray.style.pointerEvents="none"; ray.style.transform=`rotate(${ray.style.getPropertyValue("--angle")}) translate(0px)`; }); toggleIcon.classList.remove("active"); }
document.addEventListener("click",(e)=>{ if(!centerToggle.contains(e.target)) hideAllRays(); });

const modal = document.getElementById("imgModal");
const modalImg = document.getElementById("modalImg");
const canvas = document.getElementById("rulerCanvas");
const ctx = canvas.getContext('2d');

let isDrawing = false;
let startX = 0, startY = 0;

// Update canvas size whenever image loads
modalImg.addEventListener('load', () => {
  canvas.width = modalImg.clientWidth;
  canvas.height = modalImg.clientHeight;
  canvas.style.width = modalImg.clientWidth + 'px';
  canvas.style.height = modalImg.clientHeight + 'px';
  canvas.style.pointerEvents = 'auto';
  ctx.clearRect(0,0,canvas.width,canvas.height);
});

// Mouse events
canvas.addEventListener('mousedown', (e) => {
  e.stopPropagation(); // <--- add this
  isDrawing = true;
  const rect = canvas.getBoundingClientRect();
  startX = e.clientX - rect.left;
  startY = e.clientY - rect.top;
});

canvas.addEventListener('mousemove', (e) => {
  e.stopPropagation(); // <--- add this
  if (!isDrawing) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = '#ffeb3b';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(startX, startY);
  ctx.lineTo(x, startY);
  ctx.moveTo(startX, startY);
  ctx.lineTo(startX, y);
  ctx.stroke();
});

canvas.addEventListener('mouseup', (e) => {
  e.stopPropagation(); // <--- add this
  isDrawing = false;
});

canvas.addEventListener('mouseleave', (e) => {
  e.stopPropagation(); // <--- add this
  isDrawing = false;
});


</script>
<!-- Image Zoom Modal -->
<div id="imgModal" style="
  display:none;
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:2000;
">
  <div style="position:relative;">
    <img id="modalImg" src="" style="max-width:90vw; max-height:90vh; display:block; border-radius:6px;">
    <canvas id="rulerCanvas" style="
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      pointer-events:auto;
    "></canvas>

    <!-- Close Button -->
    <button id="closeModalBtn" style="
      position:absolute;
      top:10px; right:10px;
      font-size:24px;
      background: rgba(255,255,255,0.5);
      border:none; border-radius:50%;
      width:36px; height:36px;
      cursor:pointer;
      z-index:10;
    ">√ó</button>
  </div>
</div>

</body>
</html>
